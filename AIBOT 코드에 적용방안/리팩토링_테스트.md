초반 코드 설계의 중요성
=================

## 코드는 처음 설계가 중요하다

![KakaoTalk_Photo_2024-03-14-17-36-29.jpeg](..%2F..%2F..%2FDownloads%2FKakaoTalk_Photo_2024-03-14-17-36-29.jpeg)

좋은 테스트를 포함하여 처음 설계된 코드는 처음 작업 소요 시간은 기나 개발 완료 후 유지보수 면에서 훨씬 안정적인 개발이 가능하다.

* 22년 엔진 설계 당시 코드 테스트 관리 방안
    * springBootTest 활용
    * 테스트 범위
      * ScenarioProcessServiceTest.class
        * 각 노드의 샘플 시나리오를 생성하여 노드 단위 테스트
        * 노드 샘플을 연결하여 N 턴의 테스트
 	private EngineReply getBasicNodeSample() {
>		EngineReply node = new EngineReply();
>
>		node.setId(6001L);
>		node.setNodeType(ChatNodeType.BASIC);
>		node.setChipList(null);
>		node.setNext(null);
>
>		EngineReplyMessage message = new EngineReplyMessage();
>		node.getMessages().add(message);
>		message.getMessages()
>			.add("'#{USER:selectedIntent:NONE}' 업무 처리에 대해 '#{USER:intentSelectionConfirm:NONE}'을/를 선택했습니다. 대화를 종료합니다.");
>
>		return node;


* 테스트의 한계
  * 실제 저작으로 발생할 수 있는 노드와 사용되는 파라미터의 가짓수는 매우 많음
    * 노드 내 세부 설정, 입력되는 발화, 노드 실행 시 컨텍스트 상태 등등..
    > 커버리지 지표: 테스트 스위트가 소스 코드를 얼마나 실행하는지의 백분율
    * 엔진 테스트는 커버리지 지표 자체는 높일 수 있으나 실제 서비스단의 테스트는 완전히 커버하기 힘듦
    * <b>100% 커버리지 = 좋은 테스트가 아니다.</b>
  
![KakaoTalk_Photo_2024-03-14-18-02-34.jpeg](..%2F..%2F..%2FDownloads%2FKakaoTalk_Photo_2024-03-14-18-02-34.jpeg)
실제 서비스에서도 무수히 많은 입력 값이 존재한다. ex) 멀티모달 화면 로딩 중 갑자기 화면을 끈다거나..

* 좋은 테스트를 위해선 해야할 작업
  * 개발 주기에 통합되어 있어야 함
  * 코드베이스에서 가장 중요한 부분만을 대상으로 함
    * 엔진에서는 ScenarioProcessService -> NodeRunningService 부분 및 엔진 응답 생성 부분
  * 최소한의 유지비로 최대의 가치를 끌어내림
    * 비즈니스 로직 테스트를 위주로 진행해야 함 


* vs 시뮬레이터 테스트
  * 시뮬레이터 테스트가 코드 테스트를 전부 커버 가능한가?

## 초기 개발시 스타일 통일의 중요성

  * 채널GW의 초기 설계 테스트 문제

채널GW는 기능 제공을 내부 챗화면(시뮬레이터)/외부 챗화면/보이스GW 3곳과 연계를 진행함.

초기 개발 시 챗봇은 시뮬레이터 위주로 테스트가 진행 되었기 때문에 기능 테스트가 많이 이루어짐.

보이스 GW와의 연동은 서비스 적용때까지 테스트가 한 번도 진행되지 않음..

보이스 연동 테스트를 신한 개발 서버에 처음 적용했을 때 당일에서야 해볼 수 있었음..

현재 신한에서 운영중인 봇은 대부분이 보이스봇. 보이스봇의 경우 연결 되어 있는 서비스(C-HUB, 보이스GW, 콜게이트 등등)
가 많아 로컬 테스트가 불가능한 상태로 배포가 되는 경우가 많음.

이런 환경이 발생한 원인

* 채널GW, 엔진의 개발 주체가 다름
* 채널GW <-> 엔진 간 비즈니스 로직 테스트 진행을 많이 하지 않음
  * 채널GW/엔진 초기 개발 당시 테스트 코드는 엔진의 내부 로직만 대부분을 차지.
* 채널GW의 각 플랫폼의 요청/응답 규격을 공통화 하지 않음



## 전체 시나리오 테스트에 적용할 수 있는 테스트 방안

* 고전파 테스트와 런던파 테스트의 차이
  * 고전파
    * 단위 테스트를 격리된 방식으로 진행한다.
    * 테스트가 서로 소통하고 실행 컨텍스트에 영향을 줄 수 있다.
    * 데이터베이스, 파일 시스템 등 외부 의존성에 영향을 받는다.
    * 고품질의 테스트를 만들고 프로젝트의 지속 가능한 성장을 달성하는데 적합함.
![KakaoTalk_Photo_2024-03-18-16-27-51 001.jpeg](..%2F..%2F..%2FDownloads%2FKakaoTalk_Photo_2024-03-18-16-27-51%20001.jpeg)

  * 런던파
    * 테스트 대상 시스템에서 협력자(공유 의존성 객체)를 분리한다.
    * 한 번에 한 클래스만 테스트한다.
    * 서로 연결된 클래스의 규모가 커져도 테스트 하기 쉽다.
    * 테스트가 실패 했을 때 어떤 기능이 실패했는지 확인이 쉽다.
![KakaoTalk_Photo_2024-03-18-16-27-58.jpeg](..%2F..%2F..%2FDownloads%2FKakaoTalk_Photo_2024-03-18-16-27-58.jpeg)

  ![KakaoTalk_Photo_2024-03-18-16-27-51 002.jpeg](..%2F..%2F..%2FDownloads%2FKakaoTalk_Photo_2024-03-18-16-27-51%20002.jpeg)

  * 기능 테스트에는 고전파가 더 좋다?
    * 격리 문제를 주로 논의하고 있는데, 이 논쟁으로 고전파(디트로이트)와 런던파(목 추종자)라는 두 개의 단위 테스트 분파로 나뉘었다. 이러한 의견 차이는 무엇이 단위를 의미하는지에 대한 관점과 테스트 대상 시스템(SUT)의 의존성 처리 방식에 영향을 미친다.
      * 런던파는 테스트 대상 단위를 서로 분리해야 한다고 한다. 테스트 대상 단위는 코드의 단위, 보통 단일 클래스다. 불변 의존성을 제외한 모든 의존성을 테스트 대역으로 대체해야 한다.
      * 고전파는 단위가 아니라 단위 테스트를 서로 분리해야 한다고 한다. 또한 테스트 대상 단위는 코드 단위가 아니라 동작 단위다. 따라서 공유 의존성만 테스트 대역응로 대체해야 한다. 공유 의존성은 테스트가 서로 실행 흐름에 영향을 미치는 수단을 제공하는 의존성이다.
      * 런던파는 더 나은 입자성의 이점, 상호 연결된 클래스의 큰 그래프에 대한 테스트 용이성 그리고 테스트 실패 후 버그가 있는 기능을 쉽게 찾을 수 있는 편의성 등을 제공한다.
      * 런던파의 장점이 처음에는 매력적으로 보인다. 그런다 몇 가지 문제가 있다. 먼저 테스트 대상 클래스에 대한 초점이 잘못됐다. 테스트는 코드 단위가 아니라 동작 단위를 검증해야 한다. 더욱이 코드 조각을 단위 테스트할 수 없다는 것은 코드 설계에 문제가 있다는 것을 알려주는 강한 징후다. 테스트 대역을 사용한다고 해도 이 문제를 해결하는 게 아니라 오히려 숨길 뿐이다. 마지막으로 테스트 실패 후 어떤 기능에 버그가 있는지 판단하는 것이 도움은 되지만, 종종 버그의 원인을 알고 있기 때문에 그리 큰 문제는 아니다. 즉, 바로 마지막에 수정한 것이 버그의 원인일 것이다.


* AIBOT에 적용할 테스트 방법
  * AIBOT 기능은 대부분이 엔드 투 엔드 테스트
  * 각 노드 기능은 클래스 별 테스트로 진행 하되 전체 테스트는 통합 테스트로 진행
![KakaoTalk_Photo_2024-03-18-18-09-42.jpeg](..%2F..%2F..%2FDownloads%2FKakaoTalk_Photo_2024-03-18-18-09-42.jpeg)

* 단위 테스트를 얼마나 나눠야 하는가(feat. 통합테스트)
  * 테스트는 해결하는 데 도움이 되는 문제를 하나로 묶어야 한다.
  ex) 우리집 강아지를 부르면, 바로 나에게 온다. -> 우리집 강아지를 부르면 왼쪽 앞다리를 움직이고, 머리를 돌리고, 꼬리를 흔들고..
  * 클래스 그래프를 설계때 부터 작게 만들어야 한다.
  * 


